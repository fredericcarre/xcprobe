name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build
        run: cargo build --release

      - name: Unit Tests
        run: cargo test --all

      - name: Upload binaries
        uses: actions/upload-artifact@v4
        with:
          name: binaries
          path: |
            target/release/xcprobe
            target/release/e2e-runner

  e2e-tests:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - scenario_a_basic_multi_proc_host
          - scenario_b_wrapper_and_env_files
          - scenario_c_batch_only_no_ports
          - scenario_d_logs_stdout_only

    steps:
      - uses: actions/checkout@v4

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: ./bin

      - name: Make binaries executable
        run: chmod +x ./bin/*

      - name: Add binaries to PATH
        run: echo "$PWD/bin" >> $GITHUB_PATH

      - name: Run E2E Test - ${{ matrix.scenario }}
        run: |
          e2e-runner run \
            --scenario tests/scenarios/${{ matrix.scenario }} \
            --artifacts ./artifacts/${{ matrix.scenario }} \
            --timeout 300

      - name: Upload artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-${{ matrix.scenario }}
          path: |
            artifacts/${{ matrix.scenario }}/bundle.tgz
            artifacts/${{ matrix.scenario }}/report.json
            artifacts/${{ matrix.scenario }}/packplan.json
            artifacts/${{ matrix.scenario }}/failed_artifacts/

  e2e-report:
    needs: e2e-tests
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          name: binaries
          path: ./bin

      - name: Make binaries executable
        run: chmod +x ./bin/*

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./all-artifacts

      - name: Generate Summary Report
        run: |
          ./bin/e2e-runner report \
            --results ./all-artifacts \
            --format text

  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Security audit
        run: cargo audit

  documentation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Build documentation
        run: cargo doc --no-deps --all-features

      - name: Check documentation links
        run: |
          # Basic check that docs build
          test -d target/doc
